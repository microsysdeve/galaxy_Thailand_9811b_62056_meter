#define INIT_EXT
#include"Include.h"

const uint8 code InitPara0[]@0x800=
{
    0x11,0x11,0x11,0x11,0x11,0x11,  //通讯地址
    0x01,0x00,0x00,0x00,0x00,0x00,  //表号

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,    //资产管理编码

    0,0,'V','0','2','2',    //额定电压
    0,0,0,0,'A','5',        //额定电流
    0,0,0,'A','0','6',      //最大电流
};

const uint8 code InitPara1[]@0x83E=
{
    0x00,'0','.','2',               //有功准确度等级
    0x00,0x00,0x00,0x00,0x00,       //电表位置信息
    0x00,0x00,0x00,0x00,0x00,0x00,           

    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,       //电表型号

    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,       //生产日期


    0x00,0x34,0x31,0x2D,0x37,0x30,
    0x30,0x32,0x2D,0x35,0x34,
    0x36,0x54,0x2F,0x4C,0x44,  //协议版本号

    0x00,0x00,0x00,0x00,0x00,0x00,  //客户编号

    0x05,                           //有功组合特征字
    0x04,                           //调制红外 
    0x08,                           //485-1
    0xf0,0x00,                      //编程有效时间(自扩)
};

const uint8 code InitPara2[]@0x87C=
{
    0x80,0x00,  //校表脉冲宽度
    0x00,0x00,  //电表运行状态字1
    0x00,0x00,  //电表运行状态字2
    0x00,0x00,  //电表运行状态字3
    0x00,0x00,  //电表运行状态字4
    0x00,0x00,  //电表运行状态字5
    0x00,0x00,  //电表运行状态字6
    0x00,0x00,  //电表运行状态字7
    0xA0,0x05,  //闭锁有效时间(自扩)
    0x03,       //闭锁次数(自扩)
    0x00,0x00,  //跳闸延时时间
    0x00,0x30,0x00,  //跳闸控制电流门限 
    0x00,  //保留
    0x83,                       //定时冻结模式字
    0x83,                       //瞬时冻结模式字
    0x83,                       //约定冻结模式字
    0x03,                       //整点冻结数据模式字
    0x83,                       //日冻结模式字

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,    //厂家编号
};

const uint8 code InitPara3[]@0x8BA=
{
    0x00,0x00,0x00,     //第一级密码
    0x00,0x00,0x00,     //第二级密码
    0x56,0x34,0x12,     //第三级密码
    0x00,0x00,0x00,     //第四级密码
    0x78,0x56,0x34,     //第五级密码
    0x00,0x00,0x00,     //第六级密码
    0x00,0x00,0x00,     //第七级密码
    0x00,0x00,0x00,     //第八级密码
    0x00,0x00,0x00,     //第九级密码
    0x00,0x01,          //第1结算日
    0x99,0x99,          //第2结算日
    0x99,0x99,          //第3结算日
    0x05,               //自动循环显示屏数
    0x05,               //轮显显示时间
    0x02,               //显示电能小数位数
    0x04,               //显示功率小数位数
    0x0e,               //按键循环显示屏数
    0x1a,               //错误显示屏位置
    0x3c,               //有电下键显显示时间(自扩)
    0x1E,               //停电下键显显示时间(自扩)
    0x00,0x00,          //停电显示时间(自扩)
    0x05,               //上电全屏时间（自扩）
    0x05,               //上电开背光时间(自扩)
    0x14,               //红外触发背光时间(自扩)
    0x3C,               //按键触发背光时间(自扩)
    0x05,               //ESAM错误字显示时间（背光亮时间）(自扩)
    0x02,               //跳闸灯自检时间(自扩)
    0x00,0x00,0x01,0x01,0x10, //整点冻结起始时间
    0x3c,                   //整点冻结时间间隔
    0x00,0x12,0x99,0x99,    //定时冻结      
    0x00,0x00,              //日冻结时间
    0x00,                   //电表运行特征字（不启用后续标志）  
};

const uint8 code InitPara4[]@0x8F8=
{
    0x00,                   //RTC温度常温偏移
    0x00,0x00,0x00,0x00,    //RTC晶体常温偏移
    0x18,                   //RTC顶点温度
    0x68,0xD9,0x04,0x00,
    0x40,0x01,0x05,0x00,
    0x80,0x20,0x05,0x00,
    0x44,0x8e,0x05,0x00,
    0x68,0xBA,0x05,0x00,    //RTC的B值
    //CRC
};

const uint8 code InitPara5[sizeof(S_JBPM)-2]@0x912=
{
    0xB0,0x04,     //表常数
    0xf0,0x55,     //标称电压
    0x88,0x13,     //标称电流
    0xb8,0xed,0xa5,0x2c,//有功能量脉冲门限值
    0x00,0x88,0x13,0x00,//有功能量潜动门限值
    0x00,0x00,0x00,0x00,//有功比差值
    0x00,0x00,0x00,0x00,//无功比差值
    0x00,0x00,0x00,0x00,//电压有效值比差
    0x00,0x00,0x00,0x00,//通道I1电流有效值比差
    0x00,0x00,0x00,0x00,//通道I2电流有效值比差
    0x00,0x00,0x00,0x00,//有功功率二次补偿值
    0x00,0x00,0x00,0x00,//无功功率二次补偿值
    0x00,               //通道I1角差校正值
    0x00,               //通道I2角差校正值
    0x01,0x00,0x00,0x00,//电压显示比例系数k
    0x01,0x00,0x00,0x00,//电流I1显示比例系数k
    0x01,0x00,0x00,0x00,//电流I2显示比例系数k
    0x01,0x00,0x00,0x00,//功率显示比例系数k
    0x03,               //通道增益
    //CRC
};


const uint8 code InitPara6[]@0x94F=
{
    0x00,0x00,0x18,0x23,0x05,0x12,0x03,//当前时钟备份(自扩)
    //当前有功备份的CRC校验(自扩)
//reserved
//自动校表比对参数


};


const uint8 code InitPara7[]@0x956=
{
    0x02,                       //年时区数
    0x02,                       //日时段表数
    0x08,                       //日时段（每组合总电量日切换）
    0x04,                       //费率数
    0x7F,                       //周休日特征字
    0x01,                       //周休日采用时段表号
    0x30,0x00,                  //身份认证时效
    0x00,0x00,                  //公共假日数
    0x00,0x00,0x00,0x00,0x00,   //时区表切换时间
    0x00,0x00,0x00,0x00,0x00,   //时段表切换时间
    0x03,                       //功率反向事件判定延时时间
    0x33,0x00,0x00,             //功率反向事件有功功率触发下限 5A 220V 1100W 0.3%=3.3W
    0x00,                       //保留    
    0x50,                       //CF保存配置项（自扩）
    0x00,                       //抄表日补冻配置项（自扩）
    0x00,                       //冻结补冻配置项（自扩）
    0x00,0x00,                  //密码等级有效配置项（自扩）
    0x00,                       //时区和时段切换时间设置判断方式（自扩）
    0x02,                       //电量显示格式参数配置项（自扩）
    0x00,                       //时间显示格式参数配置项（自扩）
    0x00,                       //停电显示模式参数配置项（自扩）
    0x00,//继电器检测方式参数配置项（自扩）
    0x00,//电表清零次数（自扩）
    0x00,0x00,0x00,0x00,//电表清零电量阀值（自扩）
    0x55,               //生产模式状态(自扩)
    0xA0,0x05,          //生产模式退出剩余时间(自扩)
    0x14,               //密钥总条数
    0xaa,0xaa,0xaa,0xaa,0xaa,   //软件备案号
    0xaa,0xaa,0xaa,
    0x00,0x00,0x00,0x00,        //密钥状态字
//    0x00,0xfb,0x7e,0xff,0xff,0xff,   //主动上报模式字
    0x30,0x00,          //过流下限 BCD
    0x3C,               //过流延时时间 HEX
    0xA0,0x05,//预跳闸（超拉闸）控制电流门限保护延时时间
    0x1e,     //红外认证时效
};

const uint8 code InitPara8[]@0x994=
{
    0x00,0x04,0x00,0x00,0x00,0x00,0x02,0x00,   //主动上报模式字
    0x1e,                 //主动上报状态字自动复位延时时间
    0x0f,                 //负荷记录模式字   
    0x0f,0x00,            //第1类负荷记录间隔时间
    0x0f,0x00,            //第2类负荷记录间隔时间
    0x0f,0x00,            //第3类负荷记录间隔时间
    0x0f,0x00,            //第4类负荷记录间隔时间
    0x00,0x00,0x01,0x01,  //负荷记录起始时间
    0x00,                 //负荷记录起始标志（年）
};

const uint8 code InitPara9[]@0x9AB=
{
    0x01,0x01,0x01,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,  //第一套时区表
};

const uint8 code InitPara10[]@0x9D5=
{
    0x01,0x00,0x00,
    0x02,0x00,0x03,
    0x03,0x00,0x06,
    0x04,0x00,0x09,
    0x01,0x00,0x12,
    0x02,0x00,0x15,
    0x03,0x00,0x18,
    0x04,0x00,0x21,    
    0x04,0x00,0x21,
    0x04,0x00,0x21,
    0x04,0x00,0x21,
    0x04,0x00,0x21,
    0x04,0x00,0x21,
    0x04,0x00,0x21,
    //第1套第1日时段表
};
const uint8 code InitPara18[]@0x9FF=
{
    0x01,0x01,0x01,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,
    0x02,0x01,0x06,  
    //第二套时区表
};

const uint8 code InitPara19[]@0xA29=
{
    0x01,0x00,0x00,
    0x02,0x00,0x03,
    0x03,0x00,0x06,
    0x04,0x00,0x09,
    0x01,0x00,0x12,
    0x02,0x00,0x15,
    0x03,0x00,0x18,
    0x04,0x00,0x21,    
    0x04,0x00,0x21,
    0x04,0x00,0x21,
    0x04,0x00,0x21,
    0x04,0x00,0x21,
    0x04,0x00,0x21,
    0x04,0x00,0x21, 
    //第二套第1日时段表
};

const uint8 code InitPara27[]@0xA53=
{

    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,    //厂家软件版本号
};

const uint8 code InitPara28[]@0xA73=
{
    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,    //厂家硬件版本号

};

const uint8 code InitPara29[]@0xA93=
{
    0x00,0x00,0x00,0x00,0x00,       //按显1  当前总电量
    0x00,0x01,0x00,0x00,0x00,       //按显2  当前尖电量
    0x00,0x02,0x00,0x00,0x00,       //按显3  当前峰电量
    0x00,0x03,0x00,0x00,0x00,       //按显4  当前平电量
    0x00,0x04,0x00,0x00,0x00,       //按显5  当前谷电量
    //下面是预留
    0x01,0x01,0x00,0x04,0x00,       //循显6 日期
    0x02,0x01,0x00,0x04,0x00,       //循显7 时间
    0x00,0x00,0x00,0x00,0x00,       //循显8
    0x00,0x00,0x00,0x00,0x00,       //循显9
    0x00,0x00,0x00,0x00,0x00,       //循显10
    0x00,0x00,0x00,0x00,0x00,       //循显11
    0x00,0x00,0x00,0x00,0x00,       //循显12
    0x00,0x00,0x00,0x00,0x00,       //循显13
    0x00,0x00,0x00,0x00,0x00,       //循显14
    0x00,0x00,0x00,0x00,0x00,       //循显15
    0x00,0x00,0x00,0x00,0x00,       //循显16
    0x00,0x00,0x00,0x00,0x00,       //循显17
    0x00,0x00,0x00,0x00,0x00,       //循显18
    0x00,0x00,0x00,0x00,0x00,       //循显19
    0x00,0x00,0x00,0x00,0x00,       //循显20
};

const uint8 code InitPara37[]@0xAF7=
{
    0x00,0x00,0x00,0x00,0x00,       //按显1  当前总电量
    0x00,0x01,0x00,0x00,0x00,       //按显2  当前尖电量
    0x00,0x02,0x00,0x00,0x00,       //按显3  当前峰电量
    0x00,0x03,0x00,0x00,0x00,       //按显4  当前平电量
    0x00,0x04,0x00,0x00,0x00,       //按显5  当前谷电量
    0x01,0x00,0x00,0x00,0x00,       //按显6  上1月当前总电量
    0x01,0x01,0x00,0x00,0x00,       //按显7  上1月当前尖电量
    0x01,0x02,0x00,0x00,0x00,       //按显8  上1月当前峰电量
    0x01,0x03,0x00,0x00,0x00,       //按显9  上1月当前平电量
    0x01,0x04,0x00,0x00,0x00,       //按显10 上1月当前谷电量
    0x01,0x04,0x00,0x04,0x01,       //按显11 通讯地址低8位
    0x01,0x04,0x00,0x04,0x00,       //按显12 通讯地址高4位
    0x01,0x01,0x00,0x04,0x00,       //按显13 日期
    0x02,0x01,0x00,0x04,0x00,       //按显14 时间

    //下面是预留
    0x02,0x00,0x00,0x00,0x00,       //按显15 上2月组合总电量
    0x02,0x01,0x00,0x00,0x00,       //按显16 上2月组合尖电量
    0x02,0x02,0x00,0x00,0x00,       //按显17 上2月组合峰电量
    0x02,0x03,0x00,0x00,0x00,       //按显18 上2月组合平电量
    0x02,0x04,0x00,0x00,0x00,       //按显19 上2月组合谷电量
    0x0E,0x04,0x00,0x04,0x01,       //按显20 客户编号低8位
    0x0E,0x04,0x00,0x04,0x00,       //按显21 客户编号高4位
    0x02,0x04,0x00,0x04,0x01,       //按显22 表号低8位
    0x02,0x04,0x00,0x04,0x00,       //按显23 表号高4位
    0x00,0x01,0x01,0x02,0x00,       //按显24 电压
    0x00,0x01,0x02,0x02,0x00,       //按显25 电流
    0x01,0x00,0x80,0x02,0x00,       //按显26 零线电流
    0x00,0x00,0x03,0x02,0x00,       //按显27 功率
    0x00,0x00,0x06,0x02,0x00,       //按显28 功率因数
    0x00,0x00,0x00,0x00,0x00,       //按显29
    0x00,0x00,0x00,0x00,0x00,       //按显30
    0x00,0x00,0x00,0x00,0x00,       //按显31
    0x00,0x00,0x00,0x00,0x00,       //按显32
    0x00,0x00,0x00,0x00,0x00,       //按显33
    0x00,0x00,0x00,0x00,0x00,       //按显34
    0x00,0x00,0x00,0x00,0x00,       //按显35
    0x00,0x00,0x00,0x00,0x00,       //按显36
    0x00,0x00,0x00,0x00,0x00,       //按显37
    0x00,0x00,0x00,0x00,0x00,       //按显38
    0x00,0x00,0x00,0x00,0x00,       //按显39
    0x00,0x00,0x00,0x00,0x00,       //按显40
    0x00,0x00,0x00,0x00,0x00,       //按显41

};

//下面是为了对齐16保留部分
__root const uint8 code InitPara38[]@0xC00=
{   //BGP Wkup LCD1 LCD2 Bat(3600)
    0x02,0x00,0x01,0x03,0x10,0x0e, 
};

//RTC温度曲线K系数
__root const uint8 code InitParaRTC[]@0xD00=
{
    0xE5,0x03,	//0.997 
    0xE8,0x03,	//1.000 
    0xEC,0x03,	//1.004 
    0xEF,0x03,	//1.007 
    0xD9,0x03,	//0.985 
    0xDC,0x03,	//0.988 
    0xE0,0x03,	//0.992 
    0xE3,0x03,	//0.995 
    0xD3,0x03,	//0.979 
    0xD6,0x03,	//0.982 
    0xD9,0x03,	//0.985 
    0xDC,0x03,	//0.988 
    0xC6,0x03,	//0.966 
    0xC9,0x03,	//0.969 
    0xCC,0x03,	//0.972 
    0xCF,0x03,	//0.975 
    0x10,0x04,	//1.040 
    0x13,0x04,	//1.043 
    0x16,0x04,	//1.046 
    0x19,0x04,	//1.049 
    0x03,0x04,	//1.027 
    0x07,0x04,	//1.031 
    0x0A,0x04,	//1.034 
    0x0D,0x04,	//1.037 
    0xFA,0x03,	//1.018 
    0xFD,0x03,	//1.021 
    0x00,0x04,	//1.024 
    0x03,0x04,	//1.027 
    0xED,0x03,	//1.005 
    0xF1,0x03,	//1.009 
    0xF4,0x03,	//1.012 
    0xF7,0x03,	//1.015 
};

typedef struct 
{
    const uint8 code* E2ParaTabAdrr;   //E2参数表格地址
    uint16 E2Adrr;          //E2地址
    uint8  uclen;           //数据长度
}GS_E2PARA;

const  GS_E2PARA code PageCRCAddr[]=
{
    {InitPara0,     EEP_COMADD,     sizeof(InitPara0),  },
    {InitPara1,     EEP_YGACCURACY, sizeof(InitPara1),  },
    {InitPara2,     EEP_JBMCKD,     sizeof(InitPara2),  },
    {InitPara3,     EEP_645PASSWD1, sizeof(InitPara3),  },

//  {InitPara5,     EEP_JBTOTAL,    sizeof(InitPara5),  },
    {InitPara6,     EEP_DATETIME,   sizeof(InitPara6),  },

    {InitPara7,     EEP_SQCNT,      sizeof(InitPara7),  },
    {InitPara8,     EEP_ZDSBMSZ,    sizeof(InitPara8),  },
    
    {InitPara9,     EEP_1SQ,        sizeof(InitPara9),  },
    {InitPara10,    EEP_1RSDS1,     sizeof(InitPara10), },

    {InitPara10,    EEP_1RSDS2,     sizeof(InitPara10), },
    {InitPara10,    EEP_1RSDS3,     sizeof(InitPara10), },
    {InitPara10,    EEP_1RSDS4,     sizeof(InitPara10), },
    {InitPara10,    EEP_1RSDS5,     sizeof(InitPara10), },
    {InitPara10,    EEP_1RSDS6,     sizeof(InitPara10), },
    {InitPara10,    EEP_1RSDS7,     sizeof(InitPara10), },
    {InitPara10,    EEP_1RSDS8,     sizeof(InitPara10), },

    {InitPara18,    EEP_2SQ,        sizeof(InitPara18), },
    {InitPara19,    EEP_2RSDS1,     sizeof(InitPara19), },

    {InitPara19,    EEP_2RSDS2,     sizeof(InitPara19), },
    {InitPara19,    EEP_2RSDS3,     sizeof(InitPara19), },
    {InitPara19,    EEP_2RSDS4,     sizeof(InitPara19), },
    {InitPara19,    EEP_2RSDS5,     sizeof(InitPara19), },
    {InitPara19,    EEP_2RSDS6,     sizeof(InitPara19), },
    {InitPara19,    EEP_2RSDS7,     sizeof(InitPara19), },
    {InitPara19,    EEP_2RSDS8,     sizeof(InitPara19), },

    {InitPara27,    EEP_CJRJBB,     sizeof(InitPara27), },
    {InitPara28,    EEP_CJYJBB,     sizeof(InitPara28), },
};

/*=========================================================================================\n
* @function_name: InitE2Data
* @function_file: InitPara.c
* @描述: 
* 
* @参数: 
* @返回: 
* @作者:   lwb (2012-05-04)
* @备注: 
*-------------------------------------------------------------------------------------------
* @修改人:  
* @修改内容: 
===========================================================================================*/
void InitE2Data(uint8 uc_RTCSave)
{
    Word16 CRC;
    uint8 i,j;
    uint16 ShowLen;
    uint16 Wrlen;
    Word16 PrTm;

    ClRCRCWord(guc_InitWd);
    Disp_Clr();
    //通讯地址和表号，参数初始化时不更新
    FCpyTMem(XDATA_RAMZONE,PageCRCAddr[0].E2ParaTabAdrr+12,PageCRCAddr[0].uclen-12);          //拷贝Flash数据到RAM中
    SysE2ParaSetManage(PageCRCAddr[0].E2Adrr+12,XDATA_RAMZONE,PageCRCAddr[0].uclen-12);          //写入顶点温度和B值到E2中
    for(i=1;i<sizeof(PageCRCAddr)/sizeof(GS_E2PARA);i++)
    {
        CLRWDT();               //喂狗
        FCpyTMem(XDATA_RAMZONE,PageCRCAddr[i].E2ParaTabAdrr,PageCRCAddr[i].uclen);//拷贝Flash数据到RAM中
        CRC.word=do_CRC(XDATA_RAMZONE,PageCRCAddr[i].uclen);
        XDATA_RAMZONE[PageCRCAddr[i].uclen]=CRC.byte[0];
        XDATA_RAMZONE[PageCRCAddr[i].uclen+1]=CRC.byte[1];   //拷贝CRC到RAM中
        BE_WriteP(PageCRCAddr[i].E2Adrr,XDATA_RAMZONE,PageCRCAddr[i].uclen+2);   //写入到E2中
     }

    //校表参数单独判断,首先判读E2中的CRC是否正确，如果正确，则不需要初始化
    BE_ReadP(EEP_JBTOTAL,XDATA_RAMZONE,sizeof(S_JBPM));
    if(Uint8_To_Uint16(XDATA_RAMZONE+sizeof(S_JBPM)-2)!=do_CRC(XDATA_RAMZONE,sizeof(S_JBPM)-2))
    {

        CLRWDT();               //喂狗
        FCpyTMem(XDATA_RAMZONE,InitPara5,sizeof(S_JBPM)-2);                     //拷贝Flash数据到RAM中
        CRC.word=do_CRC(XDATA_RAMZONE,sizeof(S_JBPM)-2);
        XDATA_RAMZONE[sizeof(S_JBPM)-2]=CRC.byte[0];
        XDATA_RAMZONE[sizeof(S_JBPM)-1]=CRC.byte[1];                            //拷贝CRC到RAM中
        BE_WriteP(EEP_JBTOTAL,XDATA_RAMZONE,sizeof(S_JBPM));                    //写入到E2中
    }

    //写入轮显参数

    ShowLen=sizeof(InitPara29);
    for(i=0;i<((sizeof(InitPara29)-1)/64+1);i++)
    {

        CLRWDT();               //喂狗
        if(ShowLen>=64)
        {
            FCpyTMem(XDATA_RAMZONE,&InitPara29[i*64],64);    //拷贝Flash数据到RAM中
            Wrlen=64;
            ShowLen-=64;
        }else
        {
            FCpyTMem(XDATA_RAMZONE,&InitPara29[i*64],ShowLen);    //拷贝Flash数据到RAM中
            Wrlen=ShowLen;
        }

        BE_WriteP(EEP_LXTABLE+i*64,XDATA_RAMZONE,Wrlen);          //写入E2中
    }

    //写入键显参数
    ShowLen=sizeof(InitPara37); 
    for(i=0;i<((sizeof(InitPara37)-1)/64+1);i++)            
    {
        CLRWDT();                                                   //喂狗
        if(ShowLen>64)
        {
            FCpyTMem(XDATA_RAMZONE,&InitPara37[i*64],64);           //拷贝Flash数据到RAM中
            Wrlen=64;
            ShowLen-=64;
        }else
        {
            FCpyTMem(XDATA_RAMZONE,&InitPara37[i*64],ShowLen);      //拷贝Flash数据到RAM中
            Wrlen=ShowLen;
        }
        BE_WriteP(EEP_JXTABLE+i*64,XDATA_RAMZONE,Wrlen);            //写入E2中
    }

    CLRWDT();                                                       //喂狗
    
    if(uc_RTCSave == 0x55)
    {
        //写入部分RTC参数
        FCpyTMem(XDATA_RAMZONE,InitPara4+5,21);
        SysE2ParaSetManage(EEP_RTCDDTEMP,XDATA_RAMZONE,21);             //写入顶点温度和B值到E2中
        gui_RefreshEvent |= flgEtPara_RtcParaFsToE2;
        uc_RTCSave = 0;
    }

    CLRWDT();                                                       //喂狗
    MemSet(XDATA_RAMZONE,0x00,64);                                  //先清零外部RAM 
    for(i=0;i<4;i++)
    {
        BE_WriteP(EEP_JRS+64*i,XDATA_RAMZONE,64);                   //公共假日前面清零
    }

    SetCRCWord(guc_ClearWd);
    Data_ClearMeter();                                              //电表清零
 
    MemSet(XDATA_RAMZONE,0x00,64);                                              //先清零外部RAM 
    for(j=0;j<gCs_MeterClearAddrTab[0].ucPageCnt;j++)                           //参数初始化的时候清零电表清零记录
    {
        CLRWDT();               //喂狗
        BE_WriteP(gCs_MeterClearAddrTab[0].uiE2Addr+64*j,XDATA_RAMZONE,64);    //电表清零记录
    }
//
    gs_FeeData.uc_FeeRSDN=0x01;
    gs_FeeData.uc_FeeSQN=0x01;
    gs_MeterState.ui_MeterState3.RunCode3Word.RateTable=false;                  //修改电表状态字，使用第一套时段
    gs_MeterState.ui_MeterState3.RunCode3Word.TimeZoneTable=false;              //修改电表状态字，使用第一套时段
    //主动上报状态字清零
    Rpt_Clr(Const_All);
    MemSet(XDATA_RAMZONE, 0x00, RPTDATLEN);
    BE_WriteP(EEP_RPTDATA,  (uint8 *)XDATA_RAMZONE,       RPTDATLEN);  //从E2恢复
    
    guc_FactoryType = FactorMd;
    gui_DyProDmOut=0x2760;      //7天
    BE_WriteP(EEP_PRODUCELEFTTM,(uint8*)&gui_DyProDmOut,0x02);                  //厂内剩余时间
    SysE2ParaSetManage(EEP_PRODUCE,(uint8*)&guc_FactoryType,1);                 //写入厂内状态

    PrTm.byte[0]=InitPara1[60];
    PrTm.byte[1]=InitPara1[61];
    gui_DyPgmOut=PrTm.word;//编程时间
    

    SleepTimeProc();                                            //从RTC读取时钟到RAM中
    gui_RefreshEvent|=(flgEtPara_Config+flgEtPara_Fee+flgEtPara_Show+flgEtPara_LoadCurve+flgEtPara_PowDir);

    if( gs_DispStt.ucMode == Const_DispMode_Full)
    {
      gs_DispStt.ucTmr = 5;    //持续时间5s
    }
}
